.TH rig 1 "January 2019"

.SH NAME
rig \- Monitor a system for events and trigger specific actions
.SH USAGE
.B rig <RESOURCE OR SUBCOMMAND> [OPTIONS] <ACTIONS> [ACTION OPTIONS]

.PP
.SH DESCRIPTION
rig is a tool to assist in troubleshooting seemingly randomly occurring events
or events that occur at times that make active monitoring by a sysadmin difficult.

rig sets-up detached processes, known as 'rigs', that watch a given resource
for a trigger condition, and once that trigger condition is met takes actions
defined by the user.


.SH SUBCOMMANDS

.TP
.B rig list
Show a list of known existing rigs and their status. Status information is
obtained by querying the socket created for that particular rig.

.TP
.B rig destroy \-i [ID or 'all']
Destroy a deployed rig with id \fBID\fR. If \fBID\fR is 'all', destroy all known
rigs. Note that if another entity kills the pid for the running rig, destroy will
fail as the socket is no longer connected to the (now killed) process. In this case
use the \fB--force\fR option to cleanup the lingering socket.


.SH RESOURCES
These are the system resources that rig can monitor. There may be additional
manpages for specific resources. Where applicable this will be noted below.

Note that 'resources', 'monitors', and referencing 'a rig' as a distinct entity
all refer to the same thing.

When creating a rig, if successful the rig's ID will be printed to console.

.TP
.B logs
Watch a single or multiple log files and/or journald units for a specified
message. When that message is matched to any watched file or journal, the trigger
condition is met and configured actions are initiated.

The following options are available for the \fBlogs\fR rig:
.RS 7
.TP
.B \-m|\-\-message STRING
Define the string that serves as the trigger condition for the rig. This can be
a regex string or an exact message. Be very careful in using the \fB'*'\fR regex
character as this may cause unintended behavior such as the rig immediately
triggering on the first message seen.

.TP
.B \-\-logfile FILE
A comma-delimited list of files to watch. Each \fBFILE\fR specified will be
monitored from the current end of the file, so old entries will not set off the
rig's actions.

Default: /var/log/messages
.TP
.B \-\-no-files
Do not monitor any log files.
.TP
.B \-\-journal UNIT
A comma-delimited list of journal units to watch. The journal is watched as a
singular entity, and will be filtered to only read from the provided \fBUNIT(s)\fR.
If no \fBUNIT\fR is specified, the whole system journal will be monitored.

Default: 'system'
.TP
.B \-\-no-journal
Do not monitor the journal.

.RE
.SH ACTIONS
The following actions are supported responses to triggered rigs. These may be
chained together on a single rig, so deploying multiple rigs with matching trigger
conditions with single, varying actions is unnecessary.

Actions are executed based on a priority weighting system, where lower values
represent a higher priority action, and those actions with lower values are
executed before those with higher values. This is to allow more time-sensitive
actions to be taken before those that may either take a long time to execute or
are otherwise unaffected by allowing other actions to run before them. Action
priority values are set by the actions directly and are currently not able to
be modified by users.
.TP
.B gcore
Collect a coredump of a given process or processes using GDB's \fBgcore\fR utility.

Note that this does _not_ interrupt the running process(es). Cores are saved to
/tmp and will be named either core.$pid or core.$proc_name.$pid depending on if
a PID or process name was provided. This action will be executed first when a rig
is triggered and multiple actions are specified.

The \fBgcore\fR action supports the following options:
.RS 7
.TP
.B \-\-gcore PROCESS
Enables this action and takes either a PID or process name as a value. If a process
name is given, the PID is determined at rig creation. If multiple PIDs are found
for the same process name, the default behavior is to fail rig creation. Use the
\fB\-\-all-pids\fR option to instead use all PIDs discovered for a process name.

This option can be specified multiple times. E.G. \fB\-\-gcore 12345 \-\-gcore
myprocess\fR will generate a coredump for PID 12345 and a process matching the
name 'myprocess'.
.TP
.B \-\-all-pids
Tells this action to collect a coredump for \fBall\fR PIDs found for a provided
process name.
.TP
.RE
.TP
.B kdump
Generate a vmcore by triggering a kernel crash via sysrq.

Note that this action \fBWILL\fR cause node disruption by triggering a kernel panic
to generate the vmcore. This means your system \fBwill reboot\fR when this action
is triggered.

The \fBkdump\fR action does not perform any configuration checks on the system's
kdump installation. It is assumed that kdump has been properly configured and
tested prior to using this action.

The \fBkdump\fR action supports the following options:
.RS 7
.TP
.B \-\-kdump
Enables this action

.TP
.B \-\-sysrq INTEGER
When the rig is deployed, if this option is set, rig will set the system's
\fB/proc/sys/kernel/sysrq\fR to the value provided. See sysrq kernel documentation
for information on what values are supported.
.TP
.RE

.TP
.B sosreport
Run a sosreport after the rig has been triggered. There is some customizability
to the sosreport command that gets run via the \fB\-\-sos-opts\fR option described
below. This action should run after any time-sensitive actions otherwise specified
by the user for a given rig.

The \fBsosreport\fR action supports the following options:
.RS 7
.TP
.B \-\-sosreport
Enables this action
.TP
.B \-\-sos-opts OPTIONS
Specify the commandline options to use when running sosreport. Note that rig
does not do any verification of the \fBOPTIONS\fR being passed to sosreport.
.TP
.RE

.TP
.B noop

Does nothing - this action runs a no-op. This is ideally used for when you need
to test a rig's configuration to make sure a rig's trigger condition is set
properly - e.g. a regex string for the logs' rig message option.

The \fBnoop\fR action supports the following options:
.RS 7
.TP
.B \-\-noop
Enables this action
.RE
.SH MAINTAINER
.nf
Jake Hunsaker <jhunsake@redhat.com>
.fi
